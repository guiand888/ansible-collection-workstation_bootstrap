---
# Child task file: install_repos_from_urls.ansible.yml
# Installs YUM/DNF repositories from remote URLs using a three-step approach
# to handle HTTP 302 redirects gracefully

- name: Download repository RPM from URL
  ansible.builtin.get_url:
    url: "{{ item }}"
    dest: "/tmp/{{ item | basename }}"
    mode: '0644'
  loop: "{{ yum_repos_urls | default([]) }}"
  register: yum_repos_downloaded
  when: yum_repos_urls | length > 0

- name: Install downloaded repository RPMs
  ansible.builtin.dnf:
    name: "/tmp/{{ item | basename }}"
    state: present
    disable_gpg_check: true
  become: true
  loop: "{{ yum_repos_urls | default([]) }}"
  loop_control:
    label: "{{ item }}"
  register: yum_repos_from_urls_installed
  when: yum_repos_urls | length > 0
  notify: refresh yum repos cache

- name: Clean up downloaded RPMs
  ansible.builtin.file:
    path: "/tmp/{{ item | basename }}"
    state: absent
  loop: "{{ yum_repos_urls | default([]) }}"
  when: yum_repos_urls | length > 0
