---
# Child task file: install_repos_from_urls.ansible.yml
# Installs YUM/DNF repositories from remote URLs
#
# MIRRORLIST URL BEHAVIOR:
# Mirrorlist URLs (e.g., mirrors.rpmfusion.org) return HTTP 302 redirects to actual mirror servers.
# DNF5 cannot handle mirrorlist redirects when given direct RPM URLs.
# Ansible's get_url module also fails to follow these redirects properly.
#
# THREE-STEP APPROACH:
# 1. Download: Use curl with -L flag to follow redirects
# 2. Install: Use DNF with local file paths (not URLs)
# 3. Cleanup: Remove temporary files
#
# CURL FLAGS RATIONALE:
# -f: Fail silently on HTTP errors (4xx/5xx)
# -s: Silent mode (no progress bar)
# -S: Show errors even in silent mode
# -L: Follow redirects (CRITICAL for mirrorlist URLs)
# --max-redirs 5: Limit redirect chains (security)
# --connect-timeout 30: Prevent indefinite hangs
# --retry 3 --retry-delay 5: Handle transient network failures

- name: Download repository RPMs from URLs with redirect handling  # noqa: command-instead-of-module
  ansible.builtin.command: >
    curl -fsSL --retry 3 --retry-delay 5 --max-redirs 5 --connect-timeout 30
    -o "/tmp/{{ item | basename }}" "{{ item }}"
  become: true
  loop: "{{ yum_repos_urls | default([]) }}"
  loop_control:
    label: "{{ item }}"
  register: yum_repos_downloaded
  failed_when: yum_repos_downloaded.rc != 0
  changed_when: true
  when: yum_repos_urls | length > 0
  ignore_errors: "{{ ansible_check_mode }}"

- name: Install downloaded repository RPMs
  ansible.builtin.dnf:
    name: "/tmp/{{ item | basename }}"
    state: present
    disable_gpg_check: true
  become: true
  loop: >-
    {{ yum_repos_downloaded.results | selectattr('changed', 'defined') |
       selectattr('changed', 'equalto', true) |
       map(attribute='item') | list }}
  loop_control:
    label: "{{ item | basename }}"
  register: yum_repos_from_urls_installed
  when: >-
    yum_repos_downloaded is defined and
    yum_repos_downloaded.results | selectattr('changed', 'defined') |
    selectattr('changed', 'equalto', true) | list | length > 0
  notify: refresh yum repos cache
  ignore_errors: "{{ ansible_check_mode }}"

- name: Clean up downloaded RPMs
  ansible.builtin.file:
    path: "/tmp/{{ item | basename }}"
    state: absent
  become: true
  loop: >-
    {{ yum_repos_downloaded.results | selectattr('changed', 'defined') |
       selectattr('changed', 'equalto', true) |
       map(attribute='item') | list }}
  loop_control:
    label: "{{ item | basename }}"
  when: >-
    yum_repos_downloaded is defined and
    yum_repos_downloaded.results | selectattr('changed', 'defined') |
    selectattr('changed', 'equalto', true) | list | length > 0
